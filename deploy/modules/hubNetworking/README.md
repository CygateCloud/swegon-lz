# Module: Hub Networking v1.0

This module defines hub networking based on the recommendations from the Azure Landing Zone Conceptual Architecture.  

Module can deploy the following resources:

- Virtual Network (VNet)
- Subnets
- VPN Gateway/ExpressRoute Gateway
- Azure Firewall
- Private DNS Zones - Details of all the Azure Private DNS zones can be found here --> [https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#azure-services-dns-zone-configuration](https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#azure-services-dns-zone-configuration)
- DDos Standard Plan
- Bastion

## Update module image

```powershell
Publish-AzBicepModule `
-FilePath infra-as-code/bicep/modules/hubNetworking/hubNetworking.bicep `
-Target br:ccdregistryprod.azurecr.io/bicep/modules/azurefoundation/hubnetworking:v1.0
```

## Parameters

The module requires the following inputs:

 | Parameter                     | Type   | Default                                                                                              | Description                                                                                                                                                                                                                                                                                                                                                                                                                               | Requirement                   | Example                      |
 | ----------------------------- | ------ | ---------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------- | ---------------------------- |
 | parRegion                     | string | `resourceGroup().location`                                                                           | The Azure Region to deploy the resources into                                                                                                                                                                                                                                                                                                                                                                                             | None                          | `eastus`                     |
 | parBastionEnabled             | bool   | true                                                                                                 | Switch to enable deployment of Bastion Service                                                                                                                                                                                                                                                                                                                                                                                            | None                          | true                         |
 | parDdosEnabled                | bool   | false                                                                                                 | Switch to enable deployment of distributed denial of service attacks service                                                                                                                                                                                                                                                                                                                                                              | None                          | true                         |
 | parAzureFirewallEnabled       | bool   | true                                                                                                 | Switch to enable deployment of Azure Firewall                                                                                                                                                                                                                                                                                                                                                                                             | None                          | true                         |
 | parPrivateDNSZonesEnabled     | bool   | true                                                                                                 | Switch to enable deployment of Azure Private DNS Zones                                                                                                                                                                                                                                                                                                                                                                                    | None                          | true                         |
 | parPrivateDnsZones            | array  | See example parameters file [`hubNetworking.parameters.json`](hubNetworking.parameters.example.json) | Array of DNS Zones to provision in Hub Virtual Network. Default: All known Azure Private DNS Zones except for: `privatelink.batch.azure.com`, `privatelink.azmk8s.io` and `privatelink.siterecovery.windowsazure.com` as these are region specific, which you can add to the parameters file with the required region in the zone name that you wish to deploy for. For more details on private DNS Zones please refer to the above link. | None                          | See Default                  |
 | parCompanyPrefix              | string | alz                                                                                                  | Prefix value which will be pre-appended to all resource names                                                                                                                                                                                                                                                                                                                                                                             | 1-10 char                     | alz                          |
 | parDdosPlanName               | string | ${parCompanyPrefix}-DDos-Plan                                                                        | Name which will be associated with distributed denial of service protection plan                                                                                                                                                                                                                                                                                                                                                          | 1-80 char                     | alz-DDos-Plan                |
 | parBastionName                | string | ${parCompanyPrefix}-bastion                                                                          | Name which will be associated with Bastion Service.                                                                                                                                                                                                                                                                                                                                                                                       | 1-80 char                     | alz-bastion                  |
 | parBastionSku                 | string | Standard                                                                                             | SKU or Tier of Bastion Service to deploy                                                                                                                                                                                                                                                                                                                                                                                                  | Standard or Basic             | Standard                     |
 | parPublicIPSku                | string | Standard                                                                                             | SKU or Tier of Public IP to deploy                                                                                                                                                                                                                                                                                                                                                                                                        | Standard or Basic             | Standard                     |
 | parTags                       | object | Empty Array []                                                                                       | List of tags (Key Value Pairs) to be applied to resources                                                                                                                                                                                                                                                                                                                                                                                 | None                          | environment: 'development'   |
 | parHubNetworkAddressPrefix    | string | 10.10.0.0/16                                                                                         | CIDR range for Hub Network                                                                                                                                                                                                                                                                                                                                                                                                                | CIDR Notation                 | 10.10.0.0/16                 |
 | parHubNetworkName             | string | `${parCompanyPrefix}-hub-${parRegion}`                                                 | Name prefix for Virtual Network.  Prefix will be appended with the region.                                                                                                                                                                                                                                                                                                                                                                | 2-50 char                     | alz-hub-eastus              |
 | parAzureFirewallName          | string | `${parCompanyPrefix}-azure-firewall`                                                                  | Name associated with Azure Firewall                                                                                                                                                                                                                                                                                                                                                                                                       | 1-80 char                     | alz-azure-firewall           |
 | parAzureFirewallTier          | string | Standard                                                                                             | Tier associated with the Firewall to be deployed.                                                                                                                                                                                                                                                                                                                                                                                         | Standard or Premium           | Premium                      |
 | parHubRouteTableName          | string | `${parCompanyPrefix}-hub-routetable`                                                                   | Name of route table to be associated with Hub Network                                                                                                                                                                                                                                                                                                                                                                                     | 1-80 char                     | alz-hub-routetable           |
 | parVpnGatewayConfig           | object | See example parameters file [`hubNetworking.parameters.json`](hubNetworking.parameters.example.json) | Configuration for VPN virtual network gateway to be deployed. If a VPN virtual network gateway is not desired an empty object should be used as the input parameter in the parameter file, i.e. "parVpnGatewayConfig": {"value": {} }'''                                                                                                                                                                                                  | None                          | See Default                  |
 | parExpressRouteGatewayConfig  | object | See example parameters file [`hubNetworking.parameters.json`](hubNetworking.parameters.example.json) | Configuration for ExpressRoute virtual network gateway to be deployed. If a ExpressRoute virtual network gateway is not desired an empty object should be used as the input parameter in the parameter file, i.e. "parExpressRouteGatewayConfig": {"value": {} }'''                                                                                                                                                                       | None                          | See Default                  |
 | parSubnets                    | array  | See example parameters file [`hubNetworking.parameters.json`](hubNetworking.parameters.example.json) | Array of objects to provide for a dynamic set of subnets                                                                                                                                                                                                                                                                                                                                                                                  | Must provide array of objects | See Default                  |
 | parDNSServerIPArray           | array  | Empty Array []                                                                                       | Array of DNS Server IP addresses for VNet.                                                                                                                                                                                                                                                                                                                                                                                                | None                          | `['10.10.1.4', '10.10.2.4']` |
 | parNetworkDNSEnableProxy      | bool   | true                                                                                                 | Switch which enables DNS Proxy to be enabled on the Azure Firewall                                                                                                                                                                                                                                                                                                                                                                        | None                          | true                         |
 | parDisableBGPRoutePropagation | bool   | false                                                                                                | Switch which allows BGP Propagation to be disabled on the route tables                                                                                                                                                                                                                                                                                                                                                                    | None                          | false                        |
 
## Deployment

In this example, the hub resources will be deployed to the resource group specified. According to the Azure Landing Zone Conceptual Architecture, the hub resources should be deployed into the Platform connectivity subscription.

> For the examples below we assume you have downloaded or cloned the Git repo as-is and are in the root of the repository as your selected directory in your terminal of choice.

### PowerShell

```powershell
Set-AzContext -Subscription 'subscriptionId' #Set network subscription
$resourcegroup = ''
$companyprefix = ''

New-AzResourceGroupDeployment `
  -TemplateFile deploy\modules\hubNetworking\hubNetworking.bicep `
  -ResourceGroup $resourcegroup `
  -parDDoSEnabled $false `
  -parCompanyPrefix $companyprefix `
  -WhatIf
```

## Example Output
![ExampleDeploymentOutput](/deploy/pics/hubNetworkExampleDeploymentOutput.png)

 # Module: Hub Networking v1.1
 Append update information.